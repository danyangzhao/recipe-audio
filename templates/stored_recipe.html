<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ recipe.title }} - Stored Recipe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <nav class="navigation">
            <a href="{{ url_for('index') }}" class="btn btn-secondary back-btn">‚Üê Back to Home</a>
        </nav>

        <div class="page-shell recipe-layout">
            {% if recipe %}
                <header class="recipe-header">
                    <h1 class="recipe-title">{{ recipe.title or "Untitled Recipe" }}</h1>
                    {% if recipe.url %}
                        <p class="recipe-source">
                            <span class="recipe-source-name">{{ recipe.source_name or recipe.url }}</span>
                            &middot;
                            <a href="{{ recipe.url }}" target="_blank" rel="noopener noreferrer">View original recipe</a>
                        </p>
                    {% endif %}
                    <div class="recipe-meta">
                        {% if recipe.ingredients %}
                            <span class="meta-chip">{{ recipe.ingredients|length }} ingredients</span>
                        {% endif %}
                        {% if recipe.instructions %}
                            <span class="meta-chip">{{ recipe.instructions|length }} steps</span>
                        {% endif %}
                        {% if recipe.audio_filename %}
                            <span class="meta-chip meta-chip-success">Audio ready</span>
                        {% endif %}
                        {% if not recipe.ingredients and not recipe.instructions and not recipe.audio_filename %}
                            <span class="meta-chip">Recipe imported</span>
                        {% endif %}
                    </div>
                </header>

                <div id="recipe-container" class="recipe-content">
                    {% if recipe.introduction %}
                        <section class="section-card">
                            <h2>Introduction</h2>
                            <p class="introduction">{{ recipe.introduction }}</p>
                        </section>
                    {% endif %}

                    {% if recipe.ingredients %}
                        <section class="section-card">
                            <h2>Ingredients</h2>
                            <ul class="ingredients-list">
                                {% for ingredient in recipe.ingredients %}
                                    <li>
                                        {% if ingredient is mapping %}
                                            {% set ingredient_quantity = ingredient.quantity if ingredient.quantity is defined else (ingredient.amount if ingredient.amount is defined else '') %}
                                            {% set ingredient_item = ingredient.item if ingredient.item is defined else (ingredient.text if ingredient.text is defined else (ingredient.name if ingredient.name is defined else '')) %}
                                            {{ (ingredient_quantity ~ " " ~ ingredient_item)|trim }}
                                        {% else %}
                                            {{ ingredient }}
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </section>
                    {% endif %}

                    {% if recipe.instructions %}
                        <section class="section-card">
                            <h2>Instructions</h2>
                            <ol class="steps-list">
                                {% for step in recipe.instructions %}
                                    <li>
                                        {% if step is mapping %}
                                            {{ step.text if step.text is defined else (step.instruction if step.instruction is defined else (step.name if step.name is defined else '')) }}
                                        {% else %}
                                            {{ step }}
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ol>
                        </section>
                    {% endif %}

                    {% if not recipe.introduction and not recipe.ingredients and not recipe.instructions %}
                        <div class="empty-state">This recipe does not have formatted details to display yet.</div>
                    {% endif %}
                </div>

                <section class="action-panel">
                    <div class="button-row">
                        {% if not recipe.audio_filename %}
                            <button id="generate-audio" class="btn btn-primary">
                                <span class="btn-text">Generate Audio</span>
                            </button>
                        {% else %}
                            <span class="status-pill">Audio is available below</span>
                        {% endif %}

                        {% if recipe.audio_url %}
                            <a id="download-audio" class="btn btn-secondary" href="{{ recipe.audio_url }}" download>Download Audio</a>
                        {% else %}
                            <a id="download-audio" class="btn btn-secondary" href="#" download hidden>Download Audio</a>
                        {% endif %}
                    </div>
                    <div id="audio-status" class="status-message" role="status" aria-live="polite" hidden></div>
                </section>

                {% if recipe.audio_filename and recipe.audio_url %}
                    <div id="audio-container" class="audio-container">
                        <div class="audio-card">
                            <h3>Listen to your recipe</h3>
                            <audio controls preload="none" class="audio-player">
                                <source src="{{ recipe.audio_url }}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                {% else %}
                    <div id="audio-container" class="audio-container" hidden></div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>Recipe not found.</p>
                    <a href="{{ url_for('index') }}">Return home and try another recipe.</a>
                </div>
            {% endif %}
        </div>
    </div>

    {% if recipe %}
    <script id="recipe-data" type="application/json">{{ recipe | tojson }}</script>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const recipeDataNode = document.getElementById('recipe-data');
            const generateAudioBtn = document.getElementById('generate-audio');
            const audioContainer = document.getElementById('audio-container');
            const audioStatus = document.getElementById('audio-status');
            const downloadAudioLink = document.getElementById('download-audio');
            const defaultButtonLabel = 'Generate Audio';

            if (!recipeDataNode || !generateAudioBtn) {
                return;
            }

            let recipe;
            try {
                recipe = JSON.parse(recipeDataNode.textContent);
            } catch (error) {
                console.error('Could not parse recipe data:', error);
                return;
            }

            function normalizeText(value) {
                if (typeof value !== 'string') {
                    return '';
                }
                return value.trim();
            }

            function ingredientToText(ingredient) {
                if (typeof ingredient === 'string') {
                    return ingredient.trim();
                }
                if (!ingredient || typeof ingredient !== 'object') {
                    return '';
                }
                const quantity = normalizeText(String(ingredient.quantity || ingredient.amount || ''));
                const item = normalizeText(String(ingredient.item || ingredient.text || ingredient.name || ''));
                return [quantity, item].filter(Boolean).join(' ').trim();
            }

            function stepToText(step) {
                if (typeof step === 'string') {
                    return step.trim();
                }
                if (!step || typeof step !== 'object') {
                    return '';
                }
                return normalizeText(String(step.text || step.instruction || step.name || ''));
            }

            function setAudioButtonLoading(isLoading) {
                generateAudioBtn.disabled = isLoading;
                if (isLoading) {
                    generateAudioBtn.innerHTML = '<span class="loading-spinner" aria-hidden="true"></span><span class="btn-text">Generating...</span>';
                    return;
                }
                generateAudioBtn.innerHTML = '<span class="btn-text">' + defaultButtonLabel + '</span>';
            }

            function setStatus(message, type) {
                audioStatus.hidden = false;
                audioStatus.textContent = message;
                audioStatus.className = 'status-message';
                if (type) {
                    audioStatus.classList.add('is-' + type);
                }
            }

            function renderAudioPlayer(audioUrl) {
                audioContainer.hidden = false;
                audioContainer.innerHTML = '';

                const card = document.createElement('div');
                card.className = 'audio-card';

                const heading = document.createElement('h3');
                heading.textContent = 'Listen to your recipe';
                card.appendChild(heading);

                const audio = document.createElement('audio');
                audio.controls = true;
                audio.preload = 'none';
                audio.className = 'audio-player';

                const source = document.createElement('source');
                source.src = audioUrl;
                source.type = 'audio/mpeg';
                audio.appendChild(source);
                audio.appendChild(document.createTextNode('Your browser does not support the audio element.'));

                card.appendChild(audio);
                audioContainer.appendChild(card);

                if (downloadAudioLink) {
                    downloadAudioLink.href = audioUrl;
                    downloadAudioLink.hidden = false;
                }
            }

            function buildAudioText(recipePayload) {
                const lines = [];
                const title = normalizeText(recipePayload.title);
                const introduction = normalizeText(recipePayload.introduction);
                const ingredients = Array.isArray(recipePayload.ingredients) ? recipePayload.ingredients : [];
                const steps = Array.isArray(recipePayload.instructions) ? recipePayload.instructions : [];

                if (title) {
                    lines.push('Recipe: ' + title, '');
                }
                if (introduction) {
                    lines.push(introduction, '');
                }
                if (ingredients.length > 0) {
                    lines.push('Ingredients:');
                    ingredients.forEach((ingredient) => {
                        const ingredientLine = ingredientToText(ingredient);
                        if (ingredientLine) {
                            lines.push(ingredientLine);
                        }
                    });
                    lines.push('');
                }
                if (steps.length > 0) {
                    lines.push('Instructions:');
                    steps.forEach((step, index) => {
                        const stepText = stepToText(step);
                        if (stepText) {
                            lines.push('Step ' + (index + 1) + ': ' + stepText);
                        }
                    });
                }

                return lines.join('\n').trim();
            }

            generateAudioBtn.addEventListener('click', async () => {
                const audioText = buildAudioText(recipe);
                if (!audioText) {
                    setStatus('This recipe does not have enough content for audio generation yet.', 'error');
                    return;
                }

                try {
                    setAudioButtonLoading(true);
                    setStatus('Generating audio narration. This can take up to a minute...', 'loading');

                    const response = await fetch('/generate-audio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: audioText,
                            recipeId: recipe.id || null,
                            recipeUrl: recipe.url || null
                        })
                    });
                    const data = await response.json().catch(() => ({}));

                    if (!response.ok || !data.audio_url) {
                        throw new Error(data.error || 'Failed to generate audio');
                    }

                    renderAudioPlayer(data.audio_url);
                    setAudioButtonLoading(false);
                    generateAudioBtn.hidden = true;
                    setStatus('Audio is ready to play.', 'success');
                } catch (error) {
                    console.error('Error generating audio:', error);
                    setAudioButtonLoading(false);
                    setStatus('Error generating audio. Please try again.', 'error');
                }
            });
        });
    </script>
</body>
</html> 